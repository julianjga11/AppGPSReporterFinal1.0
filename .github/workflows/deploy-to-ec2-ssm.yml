name: Deploy to EC2 via SSM

on:
  push:
    branches: [ 'devsec' ]

permissions:
  contents: read
  id-token: write

jobs:
  deploy-ssm:
    runs-on: ubuntu-latest
    env:
      EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure AWS CLI v2 is available
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y unzip curl
          if command -v aws >/dev/null 2>&1; then
            echo "Found existing aws: $(aws --version 2>&1)"
            if aws --version 2>&1 | grep -q 'aws-cli/2'; then
              echo "AWS CLI v2 detected, skipping install"
            else
              echo "AWS CLI present but not v2, installing/updating to v2"
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
              unzip -o /tmp/awscliv2.zip -d /tmp
              sudo /tmp/aws/install -i /usr/local/aws-cli -b /usr/local/bin --update || true
            fi
          else
            echo "AWS CLI not found, installing v2"
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
            unzip /tmp/awscliv2.zip -d /tmp
            sudo /tmp/aws/install -i /usr/local/aws-cli -b /usr/local/bin
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload artifact to S3 (optional)
        if: false
        run: |
          # If you prefer, zip the repo and upload to S3, then fetch from instance
          zip -r /tmp/deploy.zip .
          aws s3 cp /tmp/deploy.zip s3://my-bucket/deploy.zip

      - name: Run deploy commands via SSM (copy two files)
        run: |
          set -euo pipefail
          echo "Preparing base64 payloads for main.py and mapa.html"
          MAIN_B64=$(base64 -w0 main.py)
          MAPA_B64=$(base64 -w0 mapa.html)

          echo "Creating temporary parameters file for SSM"
          cat > /tmp/ssm-params.json << EOF
          {
            "commands": [
              "echo '${MAIN_B64}' | base64 -d > /opt/app/main.py",
              "echo '${MAPA_B64}' | base64 -d > /opt/app/mapa.html",
              "sudo chown ubuntu:ubuntu /opt/app/main.py /opt/app/mapa.html",
              "cd /opt/app && /opt/app/venv/bin/pip3 install -r requirements.txt || true",
              "sudo systemctl restart reportes-gps.service"
            ]
          }
          EOF

          echo "Sending files to instance ${EC2_INSTANCE_ID} via SSM"
          CMD_ID=$(aws ssm send-command \
            --instance-ids "${EC2_INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy files from GitHub Actions" \
            --parameters file:///tmp/ssm-params.json \
            --query 'Command.CommandId' --output text --region ${AWS_REGION})
          echo "SSM CommandId: $CMD_ID"

          # poll for status
          ATTEMPTS=0
          MAX=60
          SLEEP=5
          STATUS="Pending"
          while [ $ATTEMPTS -lt $MAX ]; do
            STATUS=$(aws ssm get-command-invocation --command-id $CMD_ID --instance-id ${EC2_INSTANCE_ID} --query 'Status' --output text --region ${AWS_REGION}) || true
            echo "Attempt $ATTEMPTS: status=$STATUS"
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ] || [ "$STATUS" = "TimedOut" ] || [ "$STATUS" = "Cancelled" ]; then
              break
            fi
            ATTEMPTS=$((ATTEMPTS+1))
            sleep $SLEEP
          done
          echo "Final status: $STATUS"
          aws ssm get-command-invocation --command-id $CMD_ID --instance-id ${EC2_INSTANCE_ID} --region ${AWS_REGION} || true
          if [ "$STATUS" != "Success" ]; then
            echo "SSM command failed with status: $STATUS"
            exit 1
          fi

      - name: (noop) finished
        run: echo "deploy step finished"
